@{
    ViewBag.Title = "Sell";
}

<style>
    .required {
        color: red !important;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -moz-appearance: textfield !important;
        -webkit-appearance: none;
        margin: 0;
    }

    fieldset.scheduler-border {
        border: 1px solid #ccc;
        padding: 0px 5px 10px 5px;
        -webkit-box-shadow: 0px 0px 0px 0px #000;
        box-shadow: 0px 0px 0px 0px #000;
    }

    legend.scheduler-border {
        margin-bottom: 5px;
        font-size: 14px;
        font-weight: bold;
        text-align: left;
        width: auto;
        padding: 0 0px;
        border-bottom: none;
        margin-left: -15px;
    }

    /*pagination*/
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -moz-appearance: textfield !important;
        -webkit-appearance: none;
        margin: 0;
    }

    .pagination {
        margin: 0px;
    }

        .pagination span {
            padding: 1px 9px;
            height: 25px;
            background-color: #dddddd;
            border: 1px solid #868e96 !important;
            color: #000;
        }

    .focusNumber {
        background-color: #3C8DBC !important;
        color: #fff;
        cursor: pointer;
        font-weight: bold;
    }

    .activePage {
        cursor: pointer;
        font-weight: bold;
    }

    .pageNumbers:hover {
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    }
    /*./pagination*/

    .table tbody > tr > td {
        vertical-align: middle !important;
    }

    .table tbody > tr > th {
        vertical-align: middle !important;
    }

    .info-box-text {
        text-transform: uppercase;
        text-align: center;
        padding-bottom: 10px;
        font-size: 18px;
        color: #000;
    }

    .info-box-content {
        padding: 9px 10px;
        margin-left: 90px;
    }

    .attendance:hover .info-box-content {
        background: #f39c12;
        color: #fff;
    }

    .attendance:hover .info-box-text {
        color: #fff;
    }

    .currenttime ul {
        padding: 0px;
        margin: 0px;
    }

        .currenttime ul li {
            display: inline;
        }

    input, select, textarea {
        height: 31px;
        width: 100% !important;
    }

    .checkboxSize {
        height: 20px;
        width: 100% !important;
    }

    th {
        white-space: nowrap;
        border: 1px solid #ccc !important;
    }

        th.trBorder, td {
            border: 1px solid #ccc !important;
        }

    #searchpagenumber {
        border: 1px solid #868e96 !important;
    }

    .box {
        margin-bottom: 0px;
    }

    @@media(min-width:768px) and (max-width:1280px) {
        .screensize {
            width: 100% !important;
        }
    }

    .modal-dialog {
        width: 60% !important;
        margin-left: 35% !important;
    }

    .modal-content {
        width: 60% !important;
    }
</style>
<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -moz-appearance: textfield !important;
        -webkit-appearance: none;
        margin: 0;
    }

    select {
        width: 245px !important;
    }

    table tr td select {
        appearance: none !important;
    }
    .content {
        min-height: 0px !important;
    }

</style>

<section class="content-header">
    <ol class="breadcrumb">
        <li><a href="~/Home/Index"><i class="fa fa-home"></i> Home</a></li>
    </ol>
    <ol class="breadcrumb">
        <button class="btn btn-green" @*data-target="#addmodal"*@ id="modalShowing" data-toggle="modal"> <i class="fa fa-plus"></i> Purchase Product</button>
    </ol>
</section>

<!-- Begin: life time stats -->
<div class="portlet light bordered">
    <div class="portlet-title">
        <div class="caption">
            <i class="icon-settings font-green"></i>
            <a href="~/Home/Index"><i class="fa fa-home"></i> Home</a>
        </div>
        <div class="actions">
            <div class="btn-group btn-group-solid pull-right">
            </div>
        </div>
    </div>
</div>
<!-- End: life time stats -->
<!--Modal Area Start-->
<div id="addmodal" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <form name="addform" class="form-horizontal" id="addform" novalidate>
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
                    <h4 class="modal-title"><span id="title"></span></h4>
                </div>
                <div class="modal-body">
                    <div class="form-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="col-md-4 control-label">
                                        Customer Name :
                                        <span class="required">*</span>
                                    </label>
                                    <div class="col-md-8">
                                        <select class="form-control" name="CustomerName" id="CustomerName" required>
                                            <option value="" selected>--Select--</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label">
                                        Product Name :
                                        <span class="required">*</span>
                                    </label>
                                    <div class="col-md-8">
                                        <select class="form-control" name="ProductName" id="ProductName" required>
                                            <option value="" selected>--Select--</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label">
                                        Selling Price :
                                        <span class="required">*</span>
                                    </label>
                                    <div class="col-md-8">
                                        <input type="number" class="form-control" name="SellingPrice" id="SellingPrice" autocomplete="off" style="width: 245px !important;"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label">
                                        Buying Price :
                                        <span class="required">*</span>
                                    </label>
                                    <div class="col-md-8">
                                        <input type="number" class="form-control" name="BuyingPrice" id="BuyingPrice" autocomplete="off" disabled style="width: 245px !important;" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label">
                                        Quantity :
                                        <span class="required">*</span>
                                    </label>
                                    <div class="col-md-8">
                                        <input type="number" class="form-control" name="Quantity" id="Quantity" required autocomplete="off" style="width: 245px !important;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-12">                               
                                <div class="col-md-3 pull-right">
                                    <input type="button" class="btn btn-primary pull-right" name="btnAdd" id="btnAdd" value="Add" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--Modal Area End-->

<section class="content">
    <table style="display:none;">
        <tr id="mainrow">

            <td>
                <select disabled class="form-control customerItem customerNameDropdown" name="customerName" style="height: 32px; width:100% !important;margin-right:65px;">
                    <option value="">--Select--</option>
                </select>
            </td>

            <td>
                <select disabled class="form-control productItem productNameDropdown" name="productName" style="height: 32px; width:100% !important;margin-right:65px;">
                    <option value="">--Select--</option>
                </select>
            </td>
            <td>
                <input type="number" class="form-control buyingItem" name="buyingPrice" autocomplete="off" readonly />
            </td>

            <td>
                <input type="number" class="form-control sellingItem" name="sellingPrice" autocomplete="off" readonly />
            </td>
            <td>
                <input type="hidden" class="form-control basicSellPrice" name="basicSellPrice" />
            </td>

            <td>
                <input type="number" class="form-control quantityItem" name="quantity" autocomplete="off" readonly />
            </td>

            <td style="padding-left:15px !important">
                <button type="button" id="plusIcon"><span class="glyphicon glyphicon-plus"></span></button>
            </td>
        </tr>
    </table>
</section>

<div class="container-fluid">
    <div class="row" style="padding-bottom: 10px;">
        <form id="productActivity">
            <div class="col-md-12 col-xs-12">
                <div class="panel panel-default mb0" id="masterDataTable" style="width:100%;height:auto;background:content-box;margin:10px 0px;display:none;">
                    <div class="col-md-12  col-xs-12">
                        <table id="dataCollection"></table>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <section class="content" style="padding-left:39%;display:none" id="TotalSum">
        <table>
            <tr>
                <td style="padding-right: 10px;">
                    Grand Total
                </td>
                <td>
                    <input type="number" class="form-control pull-right" name="totalSellingPrice" id="totalSellingPrice" readonly />
                </td>
                <td>
                    <input type="number" class="form-control  pull-right" name="totalQuantity" id="totalQuantity" readonly />
                </td>
            </tr>
        </table>
    </section>



    <div class="row">
        <div class="col-md-1 col-md-offset-8">
            <input type="button" class="btn btn-primary" name="btnSave" id="btnSave" value="Save" style="display:none" />
        </div>
    </div>
</div>


<div style="padding-top: 4%">
    <section class="content">
        <div class="row" style="padding-bottom: 10px;margin-right:0px;margin-left:0px;">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="box box-info">
                    <table class="table no-margin display table-striped table-condensed table-hover table-responsive display nowrap">
                        <thead>
                            <tr style="background: lightgray;">
                                <th style="width:5%">SL</th>
                                <th style="width:15%">Customer Name</th>
                                <th style="width:15%">Product Name</th>
                                <th style="width:15%">Buying Price</th>
                                <th style="width:15%">Selling Price</th>
                                <th style="width:15%">Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="lst"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>


<link href="~/Scripts/toastr.min.css" rel="stylesheet" />
<script src="~/Scripts/App.js"></script>
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/toastr.min.js"></script>


<script>

    $(document).ready(function () {
        GetProductSellList();
        GetProductListData();
        GetCustomerListData();

        $("#modalShowing").on('click', function (e) {
            GetProductList();
            GetCustomerList();
            $("#SellingPrice").val('');
            $("#BuyingPrice").val('');
            $("#Quantity").val('');
            $('#addmodal').modal('show');
        });

        function GetProductList() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetProductList/',
                success: function (res) {
                    $("#ProductName").empty();
                    $('#ProductName').append($('<option>', {
                        value: '',
                        text: '--Select--'
                    }));
                    $.each(res.result, function (i, item) {
                        $('#ProductName').append($('<option>', {
                            value: item.Id,
                            text: item.ProductName
                        }));
                    });
                }
            });
        };

        function GetCustomerList() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetCustomerList/',
                success: function (response) {
                    $("#CustomerName").empty();
                    $('#CustomerName').append($('<option>', {
                        value: '',
                        text: '--Select--'
                    }));
                    $.each(response.result, function (i, item) {
                        $('#CustomerName').append($('<option>', {
                            value: item.Id,
                            text: item.CustomerName
                        }));
                    });
                }
            });
        };

        $('#ProductName').on('click', function () {
            $.ajax({
                type: "GET",
                url: baseUrl + 'Values/GetEditDataById/' + $('#ProductName').val(),
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    $('#Quantity').val(res.result[0].Quantity);
                    $('#BuyingPrice').val(res.result[0].BuyingPrice);
                    $('#SellingPrice').val(res.result[0].SellingPrice);
                },
                error: function (res) {
                    console.log(res);
                }
            });
        });

        function GetProductListData() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetProductList/',
                success: function (res) {
                    $.each(res.result, function (i, item) {
                        $('.productNameDropdown').append($('<option>', {
                            value: item.Id,
                            text: item.ProductName
                        }));
                    });
                }
            });
        };

        function GetCustomerListData() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetCustomerList/',
                success: function (response) {
                    $.each(response.result, function (i, item) {
                        $('.customerNameDropdown').append($('<option>', {
                            value: item.Id,
                            text: item.CustomerName
                        }));
                    });
                }
            });
        };

        function GetProductSellList() {
            let rowCount = 0;
            let htmlData = '';
            $.ajax({
                type: "GET",
                url: baseUrl + 'Values/GetProductSellList/',
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    console.log(res.dtResult);
                    if (res.dtResult.length == 0) {
                        $("#lst").html('<th>\
                             <th colspan="5" class="text-center text-danger">' + 'Record not found!' + '</th>\
                            </th>');
                    }
                    else {
                        for (i = 0; i < res.dtResult.length; i++) {
                            rowCount = rowCount + 1;
                            htmlData +=
                                '<tr id ="' + res.dtResult[i]['Id'] + '">\
                                    <td>' + rowCount + '</td>\
                                    <td>' + res.dtResult[i]['CustomerName'] + '</td>\
                                    <td>' + res.dtResult[i]['ProductName'] + '</td>\
                                    <td>' + res.dtResult[i]['BuyingPrice'] + '</td>\
                                    <td>' + res.dtResult[i]['SellingPrice'] + '</td>\
                                    <td>' + res.dtResult[i]['Quantity'] + '</td>\
                                   </tr>';
                        };
                        $("#lst").html(htmlData);
                    }
                },
                error: function (res) {
                    console.log(res);
                    toastr["error"](res.Message);
                }
            });
        };

    });

    var list = [];
    var tokenKey = null;
    var totalSell = 0;
    var totalAmount = 0;
    var arrayList = {};
    var productList = [];
    var arrayItemObj = {};
    var productItemList = [];
    var productId = [];
    var customerId = [];

    $('#btnAdd').click(function () {
        var submitValue = false;
        var productName = $("#ProductName").val();
        var customerName = $("#CustomerName").val();
        var buyingPrice = $("#BuyingPrice").val();
        var sellingPrice = $("#SellingPrice").val();
        var quantity = $("#Quantity").val();

        if (customerName == '') {
            toastr["warning"]('Customer Name Required');
            return false;
        }
        else if (productName == '') {
            toastr["warning"]('Product Name Required');
            return false;
        }
        else if (quantity == '' || quantity == 0) {
            toastr["warning"]('Quantity Required');
            return false;
        }
        else {
            sellingPrice = parseInt(sellingPrice) * parseInt(quantity);
            totalSell = parseInt(totalSell) + parseInt(sellingPrice);
            totalAmount = parseInt(totalAmount) + parseInt(quantity);
            $("#totalSellingPrice").val(totalSell);
            $("#totalQuantity").val(totalAmount);
            arrayList = {
                ProductId: productName,
                CustomerId: customerName,
                BuyingPrice: buyingPrice,
                SellingPrice: sellingPrice,
                Quantity: quantity,
            }

            if (productName != "") {
                productId.push(productName);
            }
            if (customerName != "") {
                customerId.push(customerName);
            }

            if (productName != "" && customerName != "" && quantity != "") {
                productList.push(arrayList);
                submitValue = true;
            }

            if (submitValue == true) {
                var $newRow = $('#mainrow').clone().removeAttr('id');
                $('.productItem', $newRow).val($('#ProductName').val());
                $('.customerItem', $newRow).val($('#CustomerName').val());
                $('.buyingItem', $newRow).val($('#BuyingPrice').val());
                $('.sellingItem', $newRow).val(sellingPrice);
                $('.basicSellPrice', $newRow).val($("#SellingPrice").val());
                $('.quantityItem', $newRow).val($('#Quantity').val());
                $('#plusIcon', $newRow).addClass('addQuantity');
                $('#ProductName,#CustomerName,#BuyingPrice,#SellingPrice,#Quantity,#btnAdd', $newRow).removeAttr('id');
                $('#dataCollection').append($newRow);
                $('#ProductName,#CustomerName,#BuyingPrice,#SellingPrice,#Quantity').val('');
                $('#addmodal').modal('hide');
                $('#masterDataTable').show();
                $('#TotalSum').show();
                $('#btnSave').show();
            }
        }
    });

    $("#masterDataTable").on('click', '.addQuantity', function () {
        var getRow = $(this).closest('tr');
        var Id = getRow.find('select[name=productName]').val();

        var quantity = getRow.find('input[name=quantity]').val();
        totalAmount = parseInt(totalAmount) + 1;
        quantity = parseInt(quantity) + 1;
        getRow.find('input[name=quantity]').val(quantity);

        var selling = getRow.find('input[name=basicSellPrice]').val();
        totalSell = parseInt(totalSell) + parseInt(selling);
        selling = parseInt(selling) * parseInt(quantity);
        getRow.find('input[name=sellingPrice]').val(selling);

        arrayItemObj = {
            ProductId: getRow.find('select[name=productName]').val(),
            CustomerId: getRow.find('select[name=customerName]').val(),
            BuyingPrice: getRow.find('input[name=buyingPrice]').val(),
            SellingPrice: getRow.find('input[name=sellingPrice]').val(),
            Quantity: getRow.find('input[name=quantity]').val(),
        }

        var objIndex = productList.findIndex((obj => obj.ProductId == Id));
        productList[objIndex].SellingPrice = getRow.find('input[name=sellingPrice]').val();
        productList[objIndex].Quantity = getRow.find('input[name=quantity]').val();

        $("#totalSellingPrice").val(totalSell);
        $("#totalQuantity").val(totalAmount);

    });



    $("#btnSave").on('click', function (e) {
        var isAllValid = false;
        var data = {};
        var dt = new Date();
        var key = dt.getFullYear() + ("0" + (dt.getMonth() + 1)).slice(-2) + ("0" + dt.getDate()).slice(-2) + ("0" + dt.getHours()).slice(-2)
            + ("0" + dt.getMinutes()).slice(-2) + ("0" + dt.getSeconds()).slice(-2) + ("0" + dt.getMilliseconds()).slice(-2);
        tokenKey = key;
        if (productList.length != 0) {
            data =
            {
                TokenKey: key,
                sellList: productList,
            }
        }

        if (productList.length == 0) {
            isAllValid = false;
            toastr["warning"]('Please add Your data First!');
            return false;
        }
        else {
            isAllValid = true;
        }

        if (isAllValid == true) {
            $.ajax({
                type: "POST",
                url: baseUrl + 'Values/SaveSellingData/',
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
            }).done(function (res) {
                toastr["success"](res.Message);
                productList = [];
                productId = [];
                $('#dataCollection').remove();
                $('#masterDataTable').hide();
                $('#TotalSum').hide();
                $('#btnSave').hide();
                console.log(customerId[0]);
                var getDate = dt.getFullYear() + '-' + (dt.getMonth() + 1) + '-' + dt.getDate();
                var url = baseUrl + 'Home/InvoiceSummary?Id=' + customerId[0] + '&getDate=' + getDate + '&TokenKey=' + tokenKey;
                console.log(url);
                window.open(url, "_blank");
                window.location.href = url;
                customerId = [];
                tokenKey = null;
                window.location.reload();
            }).fail(function (res) {
                console.log(res);
                toastr["error"](res.Message);
            });
        };
    });

</script>