<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -moz-appearance: textfield !important;
        -webkit-appearance: none;
        margin: 0;
    }
    select {
        width: 245px !important;
    }
     table tr td select {
        appearance: none !important;
    }


</style>


<div class="jumbotron">
    <div class="container">
        <div class="row">
            <form id="create">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="col-md-12 col-xs-12 control-label align-right">Customer Name</label>
                        <div class="col-md-12 col-xs-12">
                            <div class="input-group">
                                <select class="form-control" name="CustomerName" id="CustomerName" required>
                                    <option value="" selected>--Select--</option>
                                </select>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="col-md-12 col-xs-12 control-label align-right">Product Name</label>
                        <div class="col-md-12 col-xs-12">
                            <div class="input-group">
                                <select class="form-control" name="ProductName" id="ProductName" required>
                                    <option value="" selected>--Select--</option>
                                </select>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="col-md-12 col-xs-12 control-label align-right">Buying Price</label>
                        <div class="col-md-12 col-xs-12">
                            <div class="input-group">
                                <input type="number" class="form-control" name="BuyingPrice" id="BuyingPrice" autocomplete="off" disabled style="width: 245px !important;" />
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="col-md-12 col-xs-12 control-label align-right">Selling Price</label>
                        <div class="col-md-12 col-xs-12">
                            <div class="input-group">
                                <input type="number" class="form-control" name="SellingPrice" id="SellingPrice" autocomplete="off" disabled style="width: 245px !important;" />
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="col-md-12 col-xs-12 control-label align-right">Quantity</label>
                        <div class="col-md-12 col-xs-12">
                            <div class="input-group">
                                <input type="number" class="form-control" name="Quantity" id="Quantity" required autocomplete="off" style="width: 245px !important;" />
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </form>
            <div class="container">
                <div class="row">
                    <div class="col-md-4">
                        <input type="button" class="btn btn-primary pull-right" name="btnAdd" id="btnAdd" value="Add" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <section class="content">
        <table style="display:none;">
            <tr id="mainrow">

                <td>
                    <select disabled class="form-control customerItem customerNameDropdown" name="customerName" style="height: 32px; width:100% !important;margin-right:65px;">
                        <option value="">--Select--</option>
                    </select>
                </td>

                <td>
                    <select disabled class="form-control productItem productNameDropdown" name="productName" style="height: 32px; width:100% !important;margin-right:65px;">
                        <option value="">--Select--</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control buyingItem" name="buyingPrice" autocomplete="off" readonly />
                </td>

                <td>
                    <input type="number" class="form-control sellingItem" name="sellingPrice" autocomplete="off" readonly />
                </td>
                <td>
                    <input type="hidden" class="form-control basicSellPrice" name="basicSellPrice"  />
                </td>

                <td>
                    <input type="number" class="form-control quantityItem" name="quantity" autocomplete="off" readonly />
                </td>

                <td style="padding-left:15px !important">
                    <button type="button" id="plusIcon"><span class="glyphicon glyphicon-plus"></span></button>
                </td>
            </tr>
        </table>
    </section>

    <div class="container-fluid">
        <div class="row" style="padding-bottom: 10px;">
            <form id="productActivity">
                <div class="col-md-12 col-xs-12">
                    <div class="panel panel-default mb0" id="masterDataTable" style="width:100%;height:auto;background:content-box;margin:10px 0px;display:none;">
                        <div class="col-md-12  col-xs-12">
                            <table id="dataCollection"></table>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <section class="content" style="padding-left:39%;display:none" id="TotalSum">
            <table>
                <tr>
                    <td style="padding-right: 10px;">
                        Grand Total
                    </td>
                    <td>
                        <input type="number" class="form-control pull-right" name="totalSellingPrice" id="totalSellingPrice" readonly />
                    </td>
                    <td>
                        <input type="number" class="form-control  pull-right" name="totalQuantity" id="totalQuantity" readonly />
                    </td>
                </tr>
            </table>
        </section>

    

        <div class="row" style="padding-top:2%">
            <div class="col-md-11">
                <input type="button" class="btn btn-primary pull-right" name="btnSave" id="btnSave" value="Save" style="display:none" />
            </div>
        </div>
    </div>


    <div style="padding-top: 4%">
        <section class="content">
            <div class="row" style="padding-bottom: 10px;margin-right:0px;margin-left:0px;">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="box box-info">
                        <table class="table no-margin display table-striped table-condensed table-hover table-responsive display nowrap">
                            <thead>
                                <tr style="background: lightgray;">
                                    <th style="width:5%">SL</th>
                                    <th style="width:15%">Customer Name</th>
                                    <th style="width:15%">Product Name</th>
                                    <th style="width:15%">Buying Price</th>
                                    <th style="width:15%">Selling Price</th>
                                    <th style="width:15%">Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="lst"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>


<link href="~/Scripts/toastr.min.css" rel="stylesheet" />
<script src="~/Scripts/App.js"></script>
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/toastr.min.js"></script>


<script>

    $(document).ready(function () {
        GetProductSellList();
        GetProductList();
        GetCustomerList();
        GetProductListData();
        GetCustomerListData();       


        function GetProductList() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetProductList/',
                success: function (res) {
                    $.each(res.result, function (i, item) {
                        $('#ProductName').append($('<option>', {
                            value: item.Id,
                            text: item.ProductName
                        }));
                    });
                }
            });
        };

        function GetCustomerList() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetCustomerList/',
                success: function (response) {
                    $.each(response.result, function (i, item) {
                        $('#CustomerName').append($('<option>', {
                            value: item.Id,
                            text: item.CustomerName
                        }));
                    });
                }
            });
        };

        $('#ProductName').on('click',function () {
            $.ajax({
                type: "GET",
                url: baseUrl + 'Values/GetEditDataById/' + $('#ProductName').val(),
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    $('#Quantity').val(res.result[0].Quantity);
                    $('#BuyingPrice').val(res.result[0].BuyingPrice);
                    $('#SellingPrice').val(res.result[0].SellingPrice);
                },
                error: function (res) {
                    console.log(res);
                }
            });
        });       

        function GetProductListData() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetProductList/',
                success: function (res) {
                    $.each(res.result, function (i, item) {
                        $('.productNameDropdown').append($('<option>', {
                            value: item.Id,
                            text: item.ProductName
                        }));
                    });
                }
            });
        };

        function GetCustomerListData() {
            $.ajax({
                type: 'GET',
                url: baseUrl + 'Values/GetCustomerList/',
                success: function (response) {
                    $.each(response.result, function (i, item) {
                        $('.customerNameDropdown').append($('<option>', {
                            value: item.Id,
                            text: item.CustomerName
                        }));
                    });
                }
            });
        };

        function GetProductSellList() {
            let rowCount = 0;
            let htmlData = '';
            $.ajax({
                type: "GET",
                url: baseUrl + 'Values/GetProductSellList/',
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    console.log(res.dtResult);
                    if (res.dtResult.length == 0) {
                        $("#lst").html('<th>\
                             <th colspan="5" class="text-center text-danger">' + 'Record not found!' + '</th>\
                            </th>');
                    }
                    else {
                        for (i = 0; i < res.dtResult.length; i++) {
                            rowCount = rowCount + 1;
                            htmlData +=
                                '<tr id ="' + res.dtResult[i]['Id'] + '">\
                                    <td>' + rowCount + '</td>\
                                    <td>' + res.dtResult[i]['CustomerName'] + '</td>\
                                    <td>' + res.dtResult[i]['ProductName'] + '</td>\
                                    <td>' + res.dtResult[i]['BuyingPrice'] + '</td>\
                                    <td>' + res.dtResult[i]['SellingPrice'] + '</td>\
                                    <td>' + res.dtResult[i]['Quantity'] + '</td>\
                                   </tr>';
                        };
                        $("#lst").html(htmlData);
                    }
                },
                error: function (res) {
                    console.log(res);
                    toastr["error"](res.Message);
                }
            });
        };

    });

    var list = [];
    var tokenKey = null;
    var totalSell = 0;
    var totalAmount = 0;
    var arrayList = {};    
    var productList = [];
    var arrayItemObj = {};
    var productItemList = [];
    var productId = [];
    var customerId = [];
    $('#btnAdd').click(function () {
        var submitValue = false;
        var productName = $("#ProductName").val();
        var customerName = $("#CustomerName").val();
        var buyingPrice = $("#BuyingPrice").val();
        var sellingPrice = $("#SellingPrice").val();
        var quantity = $("#Quantity").val();       
        
        if (customerName == '') {
            toastr["warning"]('Customer Name Required');
            return false;
        }
        else if (productName == '') {
            toastr["warning"]('Product Name Required');
            return false;
        }
        else if (quantity == '') {
            toastr["warning"]('Quantity Required');
            return false;
        }        
        else
        {
            sellingPrice = parseInt(sellingPrice) * parseInt(quantity);
            totalSell = parseInt(totalSell) + parseInt(sellingPrice);
            totalAmount = parseInt(totalAmount) + parseInt(quantity);
            $("#totalSellingPrice").val(totalSell);
            $("#totalQuantity").val(totalAmount);
            arrayList = {
                ProductId: productName,
                CustomerId: customerName,
                BuyingPrice: buyingPrice,
                SellingPrice: sellingPrice,
                Quantity: quantity,
            }

            if (productName != "") {
                productId.push(productName);
            }
            if (customerName != "") {
                customerId.push(customerName);
            }

            if (productName != "" && customerName != "" && quantity != "") {
                productList.push(arrayList);
                submitValue = true;
            }

            if (submitValue == true) {
                var $newRow = $('#mainrow').clone().removeAttr('id');
                $('.productItem', $newRow).val($('#ProductName').val());
                $('.customerItem', $newRow).val($('#CustomerName').val());
                $('.buyingItem', $newRow).val($('#BuyingPrice').val());
                $('.sellingItem', $newRow).val(sellingPrice);
                $('.basicSellPrice', $newRow).val($("#SellingPrice").val());
                $('.quantityItem', $newRow).val($('#Quantity').val());
                $('#plusIcon', $newRow).addClass('addQuantity');
                $('#ProductName,#CustomerName,#BuyingPrice,#SellingPrice,#Quantity,#btnAdd', $newRow).removeAttr('id');
                $('#dataCollection').append($newRow);
                $('#ProductName,#CustomerName,#BuyingPrice,#SellingPrice,#Quantity').val('');

                $('#masterDataTable').show();
                $('#TotalSum').show();
                $('#btnSave').show();
            }
        }         
    });

    $("#masterDataTable").on('click', '.addQuantity', function () {
        var getRow = $(this).closest('tr');
        var Id = getRow.find('select[name=productName]').val();

        var quantity = getRow.find('input[name=quantity]').val();
        totalAmount = parseInt(totalAmount) + 1;
        quantity = parseInt(quantity) + 1;
        getRow.find('input[name=quantity]').val(quantity);

        var selling = getRow.find('input[name=basicSellPrice]').val();
        totalSell = parseInt(totalSell) + parseInt(selling);
        selling = parseInt(selling) * parseInt(quantity);
        getRow.find('input[name=sellingPrice]').val(selling);

        arrayItemObj = {
            ProductId: getRow.find('select[name=productName]').val(),
            CustomerId: getRow.find('select[name=customerName]').val(),
            BuyingPrice: getRow.find('input[name=buyingPrice]').val(),
            SellingPrice: getRow.find('input[name=sellingPrice]').val(),
            Quantity: getRow.find('input[name=quantity]').val(),
        }

        var objIndex = productList.findIndex((obj => obj.ProductId == Id));
        productList[objIndex].SellingPrice = getRow.find('input[name=sellingPrice]').val();
        productList[objIndex].Quantity = getRow.find('input[name=quantity]').val();
        
        $("#totalSellingPrice").val(totalSell);
        $("#totalQuantity").val(totalAmount);

    });
    


    $("#btnSave").on('click', function (e) {
        var isAllValid = false;
        var data = {};
        var dt = new Date();
        var key = dt.getFullYear() + ("0" + (dt.getMonth() + 1)).slice(-2) + ("0" + dt.getDate()).slice(-2) + ("0" + dt.getHours()).slice(-2)
            + ("0" + dt.getMinutes()).slice(-2) + ("0" + dt.getSeconds()).slice(-2) + ("0" + dt.getMilliseconds()).slice(-2);
        tokenKey = key;
        if (productList.length != 0) {
            data =
            {
                TokenKey: key,
                sellList: productList,
            }
        }        

        if (productList.length == 0 ) {
            isAllValid = false;
            toastr["warning"]('Please add Your data First!');
            return false;
        }
        else {
            isAllValid = true;
        }

        if (isAllValid == true) {
            $.ajax({
                type: "POST",
                url: baseUrl + 'Values/SaveSellingData/',
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
            }).done(function (res) {
                toastr["success"](res.Message);
                productList = [];
                productId = [];                
                $('#dataCollection').remove();
                $('#masterDataTable').hide();
                $('#TotalSum').hide();
                $('#btnSave').hide();
                console.log(customerId[0]);
                var getDate = dt.getFullYear() + '-' + (dt.getMonth() + 1) + '-' + dt.getDate();
                var url = baseUrl + 'Home/InvoiceSummary?Id=' + customerId[0] + '&getDate=' + getDate + '&TokenKey=' + tokenKey;
                console.log(url);
                window.open(url, "_blank");
                window.location.href = url;
                customerId = [];
                tokenKey = null;
                window.location.reload();
            }).fail(function (res) {
                console.log(res);
                toastr["error"](res.Message);
            });
        };
    });

</script>